<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tokyo Ghoul: Flappy Soul</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #000;
        color: #fff;
        font-family: monospace;
        text-align: center;
      }
      #popup {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
      }
      #popup button {
        margin: 10px;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
      }
      #agree {
        background: #16a34a;
        color: white;
      }
      #leave {
        background: #dc2626;
        color: white;
      }
      canvas {
        display: block;
        margin: 30px auto;
        border: 1px solid #444;
        border-radius: 8px;
        background: black;
      }
      #gameover {
        font-size: 28px;
        color: #ff4444;
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
    </style>
  </head>
  <body>
    <div id="popup">
      <h1>‚ö†Ô∏è This game is made just for fun!</h1>
      <div>
        <button id="agree">Yes, Agree</button>
        <button id="leave">Leave</button>
      </div>
    </div>

    <canvas id="game" width="400" height="500"></canvas>
    <div id="ui"></div>

    <audio id="bgm" loop src="https://cdn.pixabay.com/download/audio/2023/09/06/audio_5e86b0e80f.mp3?filename=tokyo-ghoul-unravel-instrumental-remix-2023.mp3"></audio>
    <audio id="jump" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_44a267e10c.mp3?filename=wing-flap.mp3"></audio>
    <audio id="out" src="https://cdn.pixabay.com/download/audio/2023/04/02/audio_7c85a99a5b.mp3?filename=funny-lose-sound.mp3"></audio>

    <script>
      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");
      const bgm = document.getElementById("bgm");
      const jumpSound = document.getElementById("jump");
      const outSound = document.getElementById("out");
      const ui = document.getElementById("ui");
      let gameOver = false, score = 0, lives = 3, inSecretLobby = false;
      let bird = { x: 80, y: 200, r: 15, v: 0, g: 0.4, lift: -7 };
      const pipes = [];
      let frame = 0, secretTimer = 0;

      function spawnPipe() {
        const top = Math.random() * (canvas.height / 2);
        pipes.push({ x: canvas.width, top, bottom: top + 120 });
      }

      function reset() {
        gameOver = false;
        score = 0;
        lives = 3;
        inSecretLobby = false;
        bird.y = 200;
        bird.v = 0;
        pipes.length = 0;
        frame = 0;
        secretTimer = 0;
      }

      function draw() {
        ctx.fillStyle = inSecretLobby ? "#330000" : "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = inSecretLobby ? "#ff3366" : "#0f0";
        for (let p of pipes) {
          ctx.fillRect(p.x, 0, 50, p.top);
          ctx.fillRect(p.x, p.bottom, 50, canvas.height - p.bottom);
        }

        ctx.beginPath();
        ctx.arc(bird.x, bird.y, bird.r, 0, Math.PI * 2);
        ctx.fillStyle = inSecretLobby ? "#ffcccc" : "#fff";
        ctx.fill();

        ctx.fillStyle = "#fff";
        ctx.font = "20px monospace";
        ctx.fillText("Score: " + score, 10, 25);
        ctx.fillText("Lives: " + lives, 10, 50);
        if (inSecretLobby) ctx.fillText("Khufiya Lobby üî•", 130, 25);
      }

      function update() {
        frame++;
        secretTimer++;

        if (!inSecretLobby && secretTimer > 2400 && Math.random() < 0.01) {
          inSecretLobby = true;
          lives += 3;
          secretTimer = 0;
        } else if (inSecretLobby && secretTimer > 600) {
          inSecretLobby = false;
          secretTimer = 0;
        }

        if (frame % 90 === 0) spawnPipe();
        bird.v += bird.g;
        bird.y += bird.v;

        for (let i = pipes.length - 1; i >= 0; i--) {
          const p = pipes[i];
          p.x -= 3;

          if (
            bird.x + bird.r > p.x &&
            bird.x - bird.r < p.x + 50 &&
            (bird.y - bird.r < p.top || bird.y + bird.r > p.bottom)
          ) {
            if (lives > 1) {
              lives--;
              bird.y = 200;
              bird.v = 0;
            } else {
              outSound.currentTime = 0;
              outSound.play();
              gameOver = true;
            }
          }

          if (p.x + 50 < 0) {
            pipes.splice(i, 1);
            score += inSecretLobby ? 7 : 1;
          }
        }

        if (bird.y + bird.r > canvas.height) {
          if (lives > 1) {
            lives--;
            bird.y = 200;
            bird.v = 0;
          } else {
            outSound.currentTime = 0;
            outSound.play();
            gameOver = true;
          }
        }

        draw();
        if (!gameOver) requestAnimationFrame(update);
        else showGameOver();
      }

      function showGameOver() {
        ui.innerHTML = `<div id="gameover">üíÄ Abe noob out hogya!</div>
          <button onclick="startGame()" style="margin-top:15px;padding:10px 20px;">Restart</button>`;
      }

      function jump() {
        if (!gameOver) {
          bird.v = bird.lift;
          jumpSound.currentTime = 0;
          jumpSound.play();
        }
      }

      function startGame() {
        ui.innerHTML = "";
        reset();
        update();
      }

      canvas.addEventListener("click", jump);

      // Popup logic
      document.getElementById("agree").addEventListener("click", () => {
        document.getElementById("popup").style.display = "none";
        bgm.volume = 0.4;
        bgm.play().catch(() => {});
        startGame();
      });
      document.getElementById("leave").addEventListener("click", () => {
        window.location.href = "https://www.google.com";
      });
    </script>
  </body>
</html>
